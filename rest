#!/usr/bin/env bash

declare -A conf
conf[api]='https://api.openprovider.eu/v1beta'
conf[auth_ep]='auth/login'
conf[auth_req]='username=%s password=%s ip=0.0.0.0'
conf[auth_tok]='.data.token'
conf[auth_var]='OPENPROVIDER_AUTH'

split_top_commas() {
  local s="$1" buf='' depth=0 out=()
  for ((i=0;i<${#s};i++)); do
    c=${s:i:1}
    case $c in
      '['|'{' ) ((depth++)) ;;
      ']'|'}' ) ((depth--)) ;;
      ',' ) (( depth )) || { out+=("$buf"); buf=''; continue; } ;;
    esac
    buf+="$c"
  done
  out+=("$buf")
  printf '%s\n' "${out[@]}"
}

enc() {
  local f="$1"
  shift

  case $f in
    json)
      local kv_re='^([_A-Za-z][_A-Za-z0-9]*(\.[_A-Za-z][_A-Za-z0-9]*)*)=(.*)$' v_re='^(\{.*\}|\[.*\]|-?[0-9]+(\.[0-9]+)?|true|false|null)$'
      local json='{}' tok= k= v=

      for tok in "$@"; do
        [[ $tok =~ $kv_re ]] || { echo "bad token: $tok" >&2; exit 1; }
        k=${BASH_REMATCH[1]} v=${BASH_REMATCH[3]}

        [[ $v =~ ^\[[^][]*\]$ ]] && {
          local item quoted=()
          while IFS= read -r item; do
            quoted+=("$(enc json "item=$item" | jq -r '.item')")
          done< <(split_top_commas "${v:1:${#v}-2}")
          v="$(IFS=','; printf '[%s]' "${quoted[*]}")"
        }

        [[ $v =~ $v_re ]] || v="$(printf '%s' "$v" | jq -R '@json') | fromjson"
        json+="|setpath([\"${k//./\",\"}\"]; ($v))"
      done

      jq -n "$json";;

    uri) { for p in "$@"; do echo "${p%%=*}=$(echo -n "${p#*=}" | jq -sRr @uri)"; done; } | paste -sd '&' ;;
  esac
}

req() {
  local cmd=('curl' '-sSL') endpoint="$1" verb="${FUNCNAME[1]}" client="${FUNCNAME[2]}"
  shift

  [[ $client != 'auth' ]] && {
    [[ -v "${conf[auth_var]}" ]] || auth
    cmd+=('-H' "Authorization: Bearer ${!conf[auth_var]}")
  }

  (( $# )) && case $verb in
    post|put|patch) cmd+=('-H' 'Content-Type: application/json' '-d' "$(enc json $@)")  ;;
        get|delete) endpoint+="?$(enc uri "$@")"                                        ;;
  esac

  "${cmd[@]}" -X "${verb^^}" "${conf[api]}/$endpoint"
}

auth() {
  local user pass
  read -p  "username: " user
  read -sp "password: " pass

  declare -gx "${conf[auth_var]}"="$(post "${conf[auth_ep]}" "$(printf "${conf[auth_req]}" "$user" "$pass")" | jq -r "${conf[auth_tok]}")"
}

go() {
  local verb cmd="$1"

  for verb in post get put delete patch; do
    IFS= read -rd '' verb <<VERB
 ${verb}() { req "\$@"; }
${verb}j() { $verb "\$@" | jq; }
VERB
    eval "$verb"
  done

  [[ $(type -t "${cmd}" 2> /dev/null) == 'function' ]] && "$@"
}


go "$@"

# TODO: improve env save/restore when being sourced
[[ "${BASH_SOURCE[0]}" != "$0" ]] && unset conf enc req auth go post get put delete patch postj getj putj deletej patchj
